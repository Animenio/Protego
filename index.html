<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Protego MVP</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --navy-trust: #0A1A2F;
      --deep-emerald: #1D7A6F;
      --sky-mint: #A6E6D5;
      --warm-gold: #C4A76F;
      --bg-main: #FFFFFF;

      /* alert colors */
      --danger-red: #D64045;
      --alert-orange: #E8985E;

      --info-blue: #0F6CBD;
      --lavender: #EEF2FF;
    }

    body {
      background-color: var(--bg-main);
      color: var(--navy-trust);
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
    }

    .app-container {
      background-color: var(--bg-main);
      height: 100vh;
      width: 100%;
      max-width: 450px;
      margin: 0 auto;
      position: relative;
      display: flex;
      flex-direction: column;
      border-left: 1px solid rgba(10, 26, 47, 0.08);
      border-right: 1px solid rgba(10, 26, 47, 0.08);
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 80px;
      padding-bottom: 140px; /* extra space so footer never clashes with nav */
    }

    .card {
      background-color: #FFFFFF;
      border: 1px solid rgba(10, 26, 47, 0.08);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(10, 26, 47, 0.06);
    }

    .nav-item.active { color: var(--deep-emerald); }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 9999px;
      border: 1px solid rgba(10, 26, 47, 0.08);
      font-size: 11px;
      background-color: #F8FAFC;
    }

    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .tooltip .tooltip-content {
      visibility: hidden;
      opacity: 0;
      width: 260px;
      background-color: #0F172A;
      color: #fff;
      text-align: left;
      border-radius: 8px;
      padding: 10px 12px;
      position: absolute;
      z-index: 999;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      transition: opacity 0.2s ease;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      font-size: 12px;
      line-height: 1.4;
    }

    .tooltip:hover .tooltip-content { visibility: visible; opacity: 1; }

    /* Betting Logos simulation */
    .logo-sisal { background: #265C4B; color: white; }
    .logo-goldbet { background: #FFD700; color: black; }
    .logo-eurobet { background: #004588; color: white; }
    .logo-better { background: #F2F2F2; color: #D6001C; }
    .logo-snai { background: #E45F0F; color: white; }

    .bank-card {
      background: linear-gradient(135deg, var(--deep-emerald) 0%, var(--sky-mint) 100%);
      border: 1px solid rgba(10, 26, 47, 0.08);
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      color: #FFFFFF;
    }

    .bank-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -40%;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.25) 0%, rgba(0, 0, 0, 0) 70%);
    }
@@ -192,76 +234,158 @@
        </div>

        <!-- UPDATED: bell opens notification center -->
        <button class="relative" onclick="openNotifications()" aria-label="Notifiche">
          <i class="fas fa-bell text-slate-400"></i>
          <span id="notif-dot"
                class="absolute -top-1 -right-1 w-2 h-2 rounded-full border border-white"
                style="background-color: var(--warm-gold); display:none;"></span>
        </button>
      </div>
    </div>
  </header>

  <main id="main-content" class="content-area scrollbar-hide">

    <section id="view-home" class="px-5 py-4 space-y-6">
      <div class="text-center py-4">
        <p class="text-slate-500 text-sm uppercase tracking-widest mb-1">Salvato finora</p>
        <h1 class="text-5xl font-bold mb-2" style="color: var(--navy-trust);">
          <span id="home-total-display">€ 14.500</span><span class="text-slate-400 text-3xl">,00</span>
        </h1>

        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border mb-2"
             style="background: linear-gradient(90deg, rgba(166,230,213,0.35) 0%, rgba(29,122,111,0.20) 100%); border-color: rgba(29,122,111,0.45);">
          <i class="fas fa-magic text-xs" style="color: var(--warm-gold);"></i>
          <span id="saving-rate-label" class="text-xs" style="color: var(--navy-trust);">
          <span id="saving-rate-label" class="text-xs flex items-center gap-2" style="color: var(--navy-trust);">
            Investimento autom.: <strong>12%</strong> sui volumi
            <button onclick="openExplainability()" class="text-[10px] px-2 py-1 rounded-full border border-white/50 bg-white/70 text-slate-600 hover:text-slate-900" aria-label="Spiega come funziona">
              Come funziona
            </button>
          </span>
        </div>

        <div id="cooling-banner" class="mt-2 hidden">
          <div class="pill border-amber-200 bg-amber-50 flex-wrap" style="border-color: rgba(233,180,60,0.5);">
            <div class="flex items-center gap-2">
              <i class="fas fa-hourglass-half text-[11px]" style="color: var(--alert-orange);"></i>
              <span class="text-[11px] text-slate-700">Cambio protezione in attesa (48h). Attivazione tra <strong id="cooling-countdown">—</strong>.</span>
            </div>
            <button onclick="cancelCoolingChange()" class="ml-auto text-[10px] px-2 py-1 rounded-full border border-amber-200 bg-white/70 text-amber-700 hover:bg-amber-100" aria-label="Annulla richiesta di modifica">
              Annulla richiesta
            </button>
          </div>
        </div>

        <div class="mt-2 inline-flex items-center gap-2 px-3 py-2 rounded-full border"
             style="background-color: #FFF9ED; border-color: rgba(196,167,111,0.55);">
          <i class="fas fa-heartbeat text-xs" style="color: var(--warm-gold);"></i>
          <span class="text-[11px]" style="color: var(--navy-trust);">
            Modalità <strong>Protezione</strong> attiva • Limite mensile gioco: <strong id="home-monthly-limit">€ 1.200</strong>
          </span>
        </div>

        <div class="mt-5 w-full max-w-xs mx-auto text-left">
          <div class="flex justify-between text-[10px] text-slate-500 mb-1">
            <span>Obiettivo: Fondo Sicurezza € 20.000</span>
            <span id="goal-percentage">73%</span>
      <div class="mt-5 w-full max-w-xs mx-auto text-left">
        <div class="flex justify-between text-[10px] text-slate-500 mb-1">
          <span>Obiettivo: Fondo Sicurezza € 20.000</span>
          <span id="goal-percentage">73%</span>
          </div>
          <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
            <div id="goal-bar"
                 class="h-full"
                 style="background: linear-gradient(90deg, var(--deep-emerald), var(--sky-mint)); width:73%"></div>
          </div>
        </div>
      </div>

      <div class="card p-4 flex flex-col gap-3">
        <div class="flex items-start justify-between gap-2">
          <div>
            <p class="text-xs text-slate-500">Stato Protezione</p>
            <p id="block-status" class="font-bold" style="color: var(--navy-trust);">Blocco attivo</p>
            <p id="psd2-latency" class="text-[11px] text-slate-500 mt-0.5">Sincronizzazione PSD2 stabile • Latenza <span class="font-semibold">32ms</span></p>
          </div>
          <div class="pill" id="connection-pill">
            <i class="fas fa-signal text-[11px]" style="color: var(--deep-emerald);"></i>
            <span id="connection-label">Connessione banca: stabile</span>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 text-[13px]">
          <div class="p-3 rounded-xl border border-slate-100 bg-slate-50">
            <p class="font-semibold flex items-center gap-2" style="color: var(--navy-trust);">
              <i class="fas fa-shield-alt text-[12px]" style="color: var(--deep-emerald);"></i>
              Cooling-off 48h
            </p>
            <p class="text-[11px] text-slate-500 mt-1">Modifiche a limiti e percentuali diventano effettive dopo 48h per evitare decisioni impulsive.</p>
          </div>
          <div class="p-3 rounded-xl border border-slate-100 bg-slate-50">
            <p class="font-semibold flex items-center gap-2" style="color: var(--navy-trust);">
              <i class="fas fa-helmet-safety text-[12px]" style="color: var(--alert-orange);"></i>
              Supporto immediato
            </p>
            <button onclick="openSupport()" class="mt-2 w-full py-2 rounded-lg text-xs font-semibold bg-white border border-slate-200 hover:bg-slate-100" aria-label="Apri risorse di aiuto">
              Risorse terapia & aiuto
            </button>
          </div>
        </div>
      </div>

      <div class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-slate-500">Protezione finanziaria</p>
            <p class="font-bold" style="color: var(--navy-trust);">Polizza parametrica attiva</p>
            <p class="text-[11px] text-slate-500 mt-1">Indennizzo automatico se i blocchi non partono in tempo.</p>
          </div>
          <div class="pill" style="border-color: rgba(29,122,111,0.3); background: rgba(166,230,213,0.35);">
            <i class="fas fa-file-shield text-[11px]" style="color: var(--deep-emerald);"></i>
            <span class="text-[11px]">Cap € 1.000/mese</span>
          </div>
        </div>

        <div class="flex items-center justify-between text-[13px]">
          <div class="flex items-center gap-2 text-slate-600">
            <i class="fas fa-robot text-[12px]" style="color: var(--warm-gold);"></i>
            <span>Decisioni spiegate e auditabili</span>
          </div>
          <button onclick="openExplainability()" class="text-xs text-[var(--deep-emerald)] font-semibold">Vedi logica</button>
        </div>

        <hr class="border-slate-100">

        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-2 text-slate-600">
            <i class="fas fa-building-columns text-[12px]" style="color: var(--info-blue);"></i>
            <span>Area Partner B2B pronta per banche e istituti</span>
          </div>
          <button class="w-full py-2 rounded-lg text-xs font-semibold border border-slate-200 hover:bg-slate-50" aria-label="Apri area partner" onclick="openPartnerModal()">
            Attivati per il whitepaper PSD2
          </button>
        </div>
      </div>

      <!-- Alert Center -->
      <section aria-label="Reminder Protego" class="space-y-2">
        <div id="alert-center" class="card p-3 hidden">
          <div class="flex items-start gap-3">
            <div id="alert-icon"
                 class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                 style="background-color: rgba(166,230,213,0.35); color: var(--deep-emerald);">
              <i class="fas fa-shield-heart"></i>
            </div>
            <div class="flex-1">
              <p id="alert-title" class="font-bold text-sm" style="color: var(--navy-trust);">
                Reminder Protego
              </p>
              <p id="alert-text" class="text-xs text-slate-500 mt-0.5 leading-relaxed">—</p>
              <div class="flex gap-2 mt-3">
                <button id="alert-dismiss"
                        class="px-3 py-2 rounded-lg text-xs font-semibold border border-slate-200 text-slate-500">
                  Ok
                </button>
                <button id="alert-cta"
                        class="px-3 py-2 rounded-lg text-xs font-semibold"
                        style="background: rgba(166,230,213,0.55); color: var(--navy-trust);">
                  Riduci ritmo
                </button>
              </div>
@@ -447,50 +571,57 @@

        <div>
          <label class="text-xs text-slate-500">Limite mensile di gioco (€)</label>
          <input id="monthly-limit-input" type="number" value="1200"
                 class="mt-1 w-full border rounded-lg px-3 py-2 text-sm">
        </div>

        <div>
          <label class="text-xs text-slate-500">Soglia Autoblocco (su limite)</label>
          <select id="block-threshold-select" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm">
            <option value="1.0">Rigida – 100% del limite</option>
            <option value="1.1" selected>Standard – 110%</option>
            <option value="1.2">Flessibile – 120%</option>
          </select>
        </div>

        <button onclick="applyRGSettings()"
                class="w-full py-2 rounded-lg text-sm font-semibold"
                style="background: rgba(166,230,213,0.6); color: var(--navy-trust);">
          Salva Impostazioni
        </button>
      </div>
    </section>
  </main>

  <footer class="px-5 py-4 bg-white border-t border-[rgba(10,26,47,0.08)] text-[11px] text-slate-500 leading-relaxed">
    <p class="font-semibold text-slate-700">Protego S.r.l. • CF/P.IVA 12345678901</p>
    <p>Registro Unico Intermediari (RUI) – Sezione E: n. E000999999 • Vigilanza IVASS. In assenza di mandato diretto, Protego opera come segnalatore: nessuna consulenza personalizzata.</p>
    <p class="mt-1">Informativa privacy GDPR per dati particolari disponibile nell'area documenti. Diritto di revoca del consenso in qualsiasi momento senza impatto sui servizi già prestati.</p>
    <div class="h-6"></div>
  </footer>

  <nav class="h-[80px] bg-white border-t border-[rgba(10,26,47,0.06)] flex justify-around items-center px-2 fixed bottom-0 w-full max-w-[450px] z-30">
    <button onclick="switchTab('home')" id="nav-home"
            class="nav-item active flex flex-col items-center gap-1 p-2 w-16 transition"
            style="color: var(--navy-trust);">
      <i class="fas fa-home text-xl mb-1"></i>
      <span class="text-[10px] font-semibold">Home</span>
    </button>
    <button onclick="switchTab('stats')" id="nav-stats"
            class="nav-item text-slate-400 flex flex-col items-center gap-1 p-2 w-16 transition">
      <i class="fas fa-chart-line text-xl mb-1"></i>
      <span class="text-[10px] font-semibold">Stats</span>
    </button>

    <button type="button" onclick="openSavingModal()" class="relative -top-6 focus:outline-none">
      <div class="w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-4"
           style="background: radial-gradient(circle at 30% 30%, var(--sky-mint), var(--deep-emerald)); border-color:#FFFFFF;">
        <i class="fas fa-shield-alt text-xl" style="color: var(--navy-trust);"></i>
        <span class="absolute -top-1 -right-1 w-3 h-3 rounded-full flex items-center justify-center"
              style="background-color: var(--warm-gold); box-shadow: 0 0 0 3px rgba(196,167,111,0.35);">
          <i class="fas fa-star text-[8px] text-white"></i>
        </span>
      </div>
    </button>

    <button onclick="switchTab('cards')" id="nav-cards"
@@ -618,87 +749,269 @@
      </button>
    </div>
  </div>

  <!-- Notifications Modal -->
  <div id="notifications-modal" class="fixed inset-0 bg-black/30 hidden z-[70]">
    <div class="absolute inset-0" onclick="closeNotifications()"></div>

    <div class="absolute bottom-0 left-0 right-0 mx-auto w-full max-w-[450px] bg-white rounded-t-2xl border-t border-[rgba(10,26,47,0.08)] p-5 animate-slide-up">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold" style="color: var(--navy-trust);">Notifiche</h3>
        <div class="flex items-center gap-2">
          <button onclick="clearNotifications()" class="text-xs text-slate-500 hover:text-slate-700">Svuota</button>
          <button onclick="closeNotifications()" class="text-sm text-slate-400 hover:text-slate-600">Chiudi</button>
        </div>
      </div>

      <div id="notifications-list" class="space-y-2 max-h-[55vh] overflow-y-auto scrollbar-hide"></div>

      <p class="text-[10px] text-slate-400 mt-3">
        Notifiche simulate per MVP (depositi, nudges e protezioni).
      </p>
    </div>
  </div>

  <!-- Explainability Modal -->
  <div id="explain-modal" class="fixed inset-0 bg-black/40 hidden z-[70]">
    <div class="absolute inset-0" onclick="closeExplainability()"></div>
    <div class="absolute bottom-0 left-0 right-0 mx-auto w-full max-w-[450px] bg-white rounded-t-2xl border-t border-[rgba(10,26,47,0.08)] p-5 space-y-3 animate-slide-up shadow-2xl">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold" style="color: var(--navy-trust);">Come decide Protego</h3>
        <button onclick="closeExplainability()" class="text-sm text-slate-400">Chiudi</button>
      </div>
      <ul class="list-disc pl-4 text-sm text-slate-600 space-y-1">
        <li>Il rate automatico è calcolato sul volume netto dei depositi monitorati via PSD2.</li>
        <li>Se i volumi superano il limite mensile impostato, scatta l'autoblocco immediato (con log tracciato) e l'investimento viene sospeso.</li>
        <li>Ogni modifica a limiti o percentuali entra in vigore dopo 48h (cooling-off) per ridurre decisioni impulsive.</li>
        <li>I dati e le decisioni sono auditabili: log firmati e visibili nella sezione notifiche.</li>
      </ul>
      <p class="text-[11px] text-slate-500">Trasparenza AI Act-ready: metrica, soglie e fallback manuali sono sempre esposti all'utente.</p>
    </div>
  </div>

  <!-- Support / Therapy Modal -->
  <div id="support-modal" class="fixed inset-0 bg-black/40 hidden z-[70]">
    <div class="absolute inset-0" onclick="closeSupport()"></div>
    <div class="absolute bottom-0 left-0 right-0 mx-auto w-full max-w-[450px] bg-white rounded-t-2xl border-t border-[rgba(10,26,47,0.08)] p-5 space-y-4 animate-slide-up shadow-2xl">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold" style="color: var(--navy-trust);">Aiuto immediato</h3>
        <button onclick="closeSupport()" class="text-sm text-slate-400">Chiudi</button>
      </div>
      <div class="space-y-2 text-sm text-slate-600">
        <div class="flex items-center gap-2 p-3 rounded-xl bg-slate-50 border border-slate-100">
          <i class="fas fa-phone-volume text-[14px]" style="color: var(--deep-emerald);"></i>
          <div>
            <p class="font-semibold" style="color: var(--navy-trust);">Numero verde Gioco d'Azzardo</p>
            <a href="tel:800558822" class="text-[13px] text-[var(--deep-emerald)] font-semibold">800 558 822</a>
          </div>
        </div>
        <div class="flex items-center gap-2 p-3 rounded-xl bg-slate-50 border border-slate-100">
          <i class="fas fa-user-md text-[14px]" style="color: var(--warm-gold);"></i>
          <div>
            <p class="font-semibold" style="color: var(--navy-trust);">Prenota colloquio con terapeuta</p>
            <p class="text-[12px] text-slate-500">Accesso a rete di specialisti certificati. Copertura spese possibile via Protego.</p>
          </div>
        </div>
        <div class="flex items-center gap-2 p-3 rounded-xl bg-slate-50 border border-slate-100">
          <i class="fas fa-shield-heart text-[14px]" style="color: var(--danger-red);"></i>
          <div>
            <p class="font-semibold" style="color: var(--navy-trust);">Pulsante di emergenza</p>
            <button class="text-[13px] text-white font-semibold px-3 py-1.5 rounded-lg" style="background-color: var(--danger-red);" onclick="triggerEmergencyBlock()">Attiva blocco totale ora</button>
          </div>
        </div>
        <div class="flex items-start gap-2 p-3 rounded-xl bg-white border border-slate-200 shadow-sm">
          <i class="fas fa-book-open text-[14px]" style="color: var(--info-blue);"></i>
          <form class="flex-1 space-y-1" onsubmit="captureEmail(event, 'family-guide')">
            <p class="font-semibold" style="color: var(--navy-trust);">Guida per le famiglie</p>
            <p class="text-[12px] text-slate-500">Ricevi il PDF “Segnali precoci da riconoscere”.</p>
            <div class="flex gap-2 mt-1">
              <input name="email" type="email" required placeholder="email aziendale o personale" class="flex-1 border rounded-lg px-3 py-2 text-sm" aria-label="Inserisci email per ricevere la guida">
              <button type="submit" class="px-3 py-2 rounded-lg text-xs font-semibold text-white" style="background: linear-gradient(90deg, var(--info-blue), var(--deep-emerald));">Invia PDF</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Partner waitlist modal -->
  <div id="partner-modal" class="fixed inset-0 bg-black/40 hidden z-[75]">
    <div class="absolute inset-0" onclick="closePartnerModal()"></div>
    <div class="absolute bottom-0 left-0 right-0 mx-auto w-full max-w-[450px] bg-white rounded-t-2xl border-t border-[rgba(10,26,47,0.08)] p-5 space-y-4 animate-slide-up shadow-2xl">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold" style="color: var(--navy-trust);">Waitlist Partner / Istituti</h3>
        <button onclick="closePartnerModal()" class="text-sm text-slate-400">Chiudi</button>
      </div>
      <p class="text-sm text-slate-600">Scarica il whitepaper tecnico sull'integrazione PSD2 e sull'assicurazione parametrica. Inserisci la mail aziendale per ricevere link e update I3P/Università.</p>
      <form class="space-y-3" onsubmit="captureEmail(event, 'partner')">
        <div>
          <label class="text-xs text-slate-500">Email aziendale</label>
          <input name="email" type="email" required placeholder="nome@banca.it" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm">
        </div>
        <div class="flex items-start gap-2 text-xs text-slate-500 bg-slate-50 border border-slate-100 rounded-lg p-3">
          <i class="fas fa-shield-alt mt-0.5" style="color: var(--deep-emerald);"></i>
          <span>Validazione in corso con partner I3P e Università: ricevi note di prova e KPI periodici.</span>
        </div>
        <button type="submit" class="w-full py-3 rounded-xl text-sm font-semibold text-white shadow" style="background: linear-gradient(90deg, var(--deep-emerald), var(--info-blue));">
          Ricevi whitepaper e aggiornamenti
        </button>
      </form>
    </div>
  </div>

  <!-- GDPR Consent Banner -->
  <div id="consent-banner" class="fixed left-0 right-0 mx-auto max-w-[450px] bottom-20 z-[80] hidden">
    <div class="m-3 p-4 rounded-2xl shadow-2xl border border-[rgba(10,26,47,0.08)] bg-white">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color: rgba(15,108,189,0.1); color: var(--info-blue);">
          <i class="fas fa-user-shield"></i>
        </div>
        <div class="flex-1 space-y-2">
          <div class="flex justify-between items-start gap-2">
            <div>
              <p class="font-bold text-sm" style="color: var(--navy-trust);">Consenso esplicito GDPR</p>
              <p class="text-xs text-slate-600">Trattiamo dati particolari (dipendenza e salute) per proteggerti. Conferma per attivare i blocchi.</p>
            </div>
            <button onclick="closeConsentBanner()" class="text-slate-400 text-sm">Chiudi</button>
          </div>
          <div class="space-y-2 text-xs text-slate-600">
            <label class="flex items-start gap-2">
              <input id="consent-monitoring" type="checkbox" class="mt-0.5" checked>
              <span>Monitoraggio transazioni e calcolo soglie (necessario).</span>
            </label>
            <label class="flex items-start gap-2">
              <input id="consent-health" type="checkbox" class="mt-0.5">
              <span>Dati particolari su dipendenza/benessere per suggerimenti personalizzati.</span>
            </label>
            <label class="flex items-start gap-2">
              <input id="consent-marketing" type="checkbox" class="mt-0.5">
              <span>Comunicazioni non essenziali (facoltativo).</span>
            </label>
          </div>
          <div class="flex gap-2">
            <button onclick="acceptConsents()" class="flex-1 py-2 rounded-lg text-sm font-semibold text-white" style="background: linear-gradient(90deg, var(--deep-emerald), var(--sky-mint));">Confermo in modo esplicito</button>
            <button onclick="saveConsentPreferences()" class="px-3 py-2 rounded-lg text-xs font-semibold border border-slate-200">Solo essenziali</button>
          </div>
          <p class="text-[10px] text-slate-400">Puoi revocare o modificare i consensi da Profilo &gt; Privacy. Informativa completa in documenti legali.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Save progress modal -->
  <div id="save-progress-modal" class="fixed inset-0 bg-black/40 hidden z-[80]">
    <div class="absolute inset-0" onclick="closeSaveProgress()"></div>
    <div class="absolute bottom-0 left-0 right-0 mx-auto w-full max-w-[450px] bg-white rounded-t-2xl border-t border-[rgba(10,26,47,0.08)] p-5 space-y-3 animate-slide-up shadow-2xl">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold" style="color: var(--navy-trust);">Salva i tuoi settaggi</h3>
        <button onclick="closeSaveProgress()" class="text-sm text-slate-400">Chiudi</button>
      </div>
      <p class="text-sm text-slate-600">Vuoi ricevere questa configurazione via email per riprenderla al prossimo accesso?</p>
      <form class="space-y-2" onsubmit="captureEmail(event, 'progress')">
        <input name="email" type="email" required placeholder="La tua email" class="w-full border rounded-lg px-3 py-2 text-sm">
        <button type="submit" class="w-full py-3 rounded-xl text-sm font-semibold text-white" style="background: linear-gradient(90deg, var(--deep-emerald), var(--warm-gold));">Invia configurazione</button>
        <p class="text-[11px] text-slate-400">Useremo la mail solo per salvare i settaggi e inviare istruzioni di recupero.</p>
      </form>
    </div>
  </div>

</div>

<script>
  const CONFIG = {
    goalValue: 20000,
    fee: 0.02,
    scenarios: {
      minGross: 0.06,
      medGross: 0.10,
      maxGross: 0.15
    },
    defaultSavingRate: 0.12,
    coolingOffMs: 48 * 60 * 60 * 1000,   // 48h real window
    coolingOffDemoMs: 15 * 1000,         // demo timer to mostrare la frizione

    responsibleGaming: {
      monthlyLimit: 1200,          // € – modificabile da Profile
      blockMultiplier: 1.10        // 100% / 110% / 120%
    },

    nudge: {
      txCountSoft: 5,
      txCountHard: 6,
      cooldownMs: 2 * 60 * 1000 // 2 minuti (demo)
    }
  };

  const STORAGE_KEYS = {
    consent: 'protego-consent',
    cooling: 'protego-cooling',
    savingRate: 'protego-saving-rate',
    savedProgress: 'protego-progress',
    capturedEmails: 'protego-leads'
  };

  // Ricostruiamo il volume di gioco "Storico" basandoci sul fatto che 14.500 sono il 12%.
  const rawHistory = [2000, 4100, 6200, 8300, 10400, 12500, 14500];
  const baseVolumeHistory = rawHistory.map(val => val / CONFIG.defaultSavingRate);

  let currentSavingRate = CONFIG.defaultSavingRate;
  let pendingSavingRate = CONFIG.defaultSavingRate;
  const savingChange = {
    pendingRate: null,
    requestedAt: null,
    deadline: null,
    demoDeadline: null,
    timer: null,
    countdown: null
  };

  // Format currency
  const fmtEur = (val) => '€ ' + Math.floor(val).toLocaleString('it-IT');

  /* ===== Notifications System ===== */
  const NOTIFS = { items: [], unread: 0 };
  const CONSENT = { monitoring: true, health: false, marketing: false, accepted: false };
  let CAPTURED_LEADS = safeStorageGet(STORAGE_KEYS.capturedEmails, []);
  const PROGRESS_STATE = { saved: safeStorageGet(STORAGE_KEYS.savedProgress, false) };

  function safeStorageGet(key, fallback=null) {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    } catch (e) {
      return fallback;
    }
  }

  function safeStorageSet(key, value) {
    try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {}
  }

  function safeStorageRemove(key) {
    try { localStorage.removeItem(key); } catch (e) {}
  }

  function fmtDateTime(d = new Date()) {
    return d.toLocaleString('it-IT', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
  }

  function addNotification({ type='info', title='Notifica', message='—' } = {}) {
    const iconByType = {
      success: 'fa-check-circle',
      warning: 'fa-exclamation-triangle',
      danger: 'fa-ban',
      info: 'fa-bell'
    };
    const bgByType = {
      success: 'rgba(29,122,111,0.12)',
      warning: '#FFF4E5',
      danger: '#FEF2F2',
      info: 'rgba(166,230,213,0.25)'
    };
    const iconColorByType = {
      success: 'var(--deep-emerald)',
      warning: 'var(--alert-orange)',
      danger: 'var(--danger-red)',
      info: 'var(--navy-trust)'
    };

@@ -750,105 +1063,200 @@
            <p class="font-bold text-sm" style="color: var(--navy-trust);">${n.title}</p>
            <p class="text-[10px] text-slate-400">${fmtDateTime(n.ts)}</p>
          </div>
          <p class="text-xs text-slate-500 mt-0.5 leading-relaxed">${n.message}</p>
        </div>
      </div>
    `).join('');
  }

  function openNotifications() {
    const modal = document.getElementById('notifications-modal');
    if (!modal) return;

    modal.classList.remove('hidden');
    NOTIFS.unread = 0;
    updateNotifDot();
    renderNotifications();
  }

  function closeNotifications() {
    const modal = document.getElementById('notifications-modal');
    if (!modal) return;
    modal.classList.add('hidden');
  }

  function captureEmail(event, type='generic') {
    event.preventDefault();
    const form = event.target;
    const emailInput = form.querySelector('input[name="email"]');
    const email = emailInput?.value?.trim();
    if (!email) return;

    CAPTURED_LEADS = CAPTURED_LEADS || [];
    CAPTURED_LEADS.push({ type, email, ts: new Date().toISOString() });
    safeStorageSet(STORAGE_KEYS.capturedEmails, CAPTURED_LEADS);

    addNotification({
      type: 'success',
      title: 'Richiesta registrata',
      message: `Riceverai il materiale richiesto su ${email}.`
    });

    if (type === 'progress') {
      PROGRESS_STATE.saved = true;
      safeStorageSet(STORAGE_KEYS.savedProgress, true);
      closeSaveProgress();
    }
    if (type === 'partner') closePartnerModal();
    if (type === 'family-guide') closeSupport();

    form.reset();
  }

  function clearNotifications() {
    NOTIFS.items = [];
    NOTIFS.unread = 0;
    updateNotifDot();
    renderNotifications();
  }

  /* ===== GDPR Consent ===== */
  function showConsentBanner() {
    const banner = document.getElementById('consent-banner');
    if (!banner) return;
    if (CONSENT.accepted) return;
    banner.classList.remove('hidden');
    syncConsentInputs();
  }

  function closeConsentBanner() {
    const banner = document.getElementById('consent-banner');
    if (banner) banner.classList.add('hidden');
  }

  function loadConsentFromStorage() {
    const saved = safeStorageGet(STORAGE_KEYS.consent);
    if (saved) {
      CONSENT.monitoring = saved.monitoring ?? CONSENT.monitoring;
      CONSENT.health = saved.health ?? CONSENT.health;
      CONSENT.marketing = saved.marketing ?? CONSENT.marketing;
      CONSENT.accepted = saved.accepted ?? CONSENT.accepted;
    }
  }

  function persistConsent() {
    safeStorageSet(STORAGE_KEYS.consent, CONSENT);
  }

  function syncConsentInputs() {
    const cMon = document.getElementById('consent-monitoring');
    const cHealth = document.getElementById('consent-health');
    const cMkt = document.getElementById('consent-marketing');
    if (cMon) cMon.checked = CONSENT.monitoring;
    if (cHealth) cHealth.checked = CONSENT.health;
    if (cMkt) cMkt.checked = CONSENT.marketing;
  }

  function acceptConsents() {
    CONSENT.monitoring = true;
    CONSENT.health = true;
    CONSENT.marketing = document.getElementById('consent-marketing')?.checked || false;
    CONSENT.accepted = true;
    persistConsent();
    closeConsentBanner();

    addNotification({
      type: 'success',
      title: 'Consenso registrato',
      message: 'Hai fornito consenso esplicito al trattamento dei dati particolari. Blocchi e protezioni restano attivi.'
    });
  }

  function saveConsentPreferences() {
    CONSENT.monitoring = document.getElementById('consent-monitoring')?.checked !== false;
    CONSENT.health = false;
    CONSENT.marketing = false;
    CONSENT.accepted = CONSENT.monitoring;
    persistConsent();
    closeConsentBanner();
    addNotification({
      type: 'info',
      title: 'Consenso essenziale',
      message: 'Stai usando solo i consensi minimi. Puoi attivare le funzioni avanzate salute in seguito.'
    });
  }

  /* ===== Navigation ===== */
  function switchTab(tabId) {
    document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById('view-' + tabId).classList.remove('hidden');

    document.querySelectorAll('.nav-item').forEach(el => {
      el.classList.remove('active');
      el.classList.add('text-slate-400');
    });
    const activeBtn = document.getElementById('nav-' + tabId);
    if (activeBtn) {
      activeBtn.classList.add('active');
      activeBtn.classList.remove('text-slate-400');
    }

    if (tabId === 'stats' && window.myChart) window.myChart.resize();
  }

  /* ===== RG Settings ===== */
  function applyRGSettings() {
    const limitInput = document.getElementById('monthly-limit-input');
    const thresholdSelect = document.getElementById('block-threshold-select');

    const newLimit = parseFloat(limitInput.value);
    const newMult = parseFloat(thresholdSelect.value);

    if (!isNaN(newLimit)) CONFIG.responsibleGaming.monthlyLimit = newLimit;
    if (!isNaN(newMult)) CONFIG.responsibleGaming.blockMultiplier = newMult;

    // Update home pill
    const homeLimit = document.getElementById('home-monthly-limit');
    if (homeLimit) homeLimit.textContent = fmtEur(CONFIG.responsibleGaming.monthlyLimit);

    showAlertCenter({
      type: 'info',
      title: 'Impostazioni salvate',
      text: 'Protego applicherà i nuovi limiti a partire da ora.',
      cta: 'Ok'
    });

    addNotification({
      type: 'info',
      title: 'Impostazioni aggiornate',
      message: `Limite mensile: ${fmtEur(CONFIG.responsibleGaming.monthlyLimit)} • Soglia autoblocco: ${Math.round(CONFIG.responsibleGaming.blockMultiplier*100)}%`
    });

    // refresh transactions so the demo shows effect
    generateTransactions();
    maybePromptSaveProgress();
  }

  /* ===== Dashboard Update ===== */
  function updateDashboard(rate) {
    const simulatedDeposits = baseVolumeHistory.map(vol => vol * rate);
    const currentTotalSaved = simulatedDeposits[simulatedDeposits.length - 1];

    const homeDisplay = document.getElementById('home-total-display');
    if (homeDisplay) homeDisplay.textContent = fmtEur(currentTotalSaved);

    const perc = Math.round(currentTotalSaved / CONFIG.goalValue * 100);
    const bar = document.getElementById('goal-bar');
    const label = document.getElementById('goal-percentage');
    if (bar) bar.style.width = Math.min(perc, 100) + '%';
    if (label) label.textContent = perc + '%';

    const statsDisplay = document.getElementById('stats-total-display');
    if (statsDisplay) statsDisplay.textContent = fmtEur(currentTotalSaved);

    const minNet = CONFIG.scenarios.minGross - CONFIG.fee;
    const medNet = CONFIG.scenarios.medGross - CONFIG.fee;
    const maxNet = CONFIG.scenarios.maxGross - CONFIG.fee;

    const minData = calculateGrowth(simulatedDeposits, minNet);
    const medData = calculateGrowth(simulatedDeposits, medNet);
@@ -865,86 +1273,112 @@
      window.myChart.data.datasets[0].data = maxData;
      window.myChart.data.datasets[1].data = medData;
      window.myChart.data.datasets[2].data = minData;
      window.myChart.data.datasets[3].data = simulatedDeposits;
      window.myChart.update();
    } else {
      initChart(maxData, medData, minData, simulatedDeposits);
    }
  }

  const bettingSites = [
    {name: "Sisal Matchpoint", class: "logo-sisal", icon: "S"},
    {name: "GoldBet", class: "logo-goldbet", icon: "G"},
    {name: "Eurobet", class: "logo-eurobet", icon: "E"},
    {name: "Lottomatica", class: "logo-better", icon: "L"},
    {name: "SNAI", class: "logo-snai", icon: "S"}
  ];

  /* ===== Responsible gaming state ===== */
  const RG = {
    monthSpendSim: 0,
    lastNudgeAt: 0,
    blockedCount: 0
  };

  const SYSTEM_STATUS = {
    latencyMs: 32,
    connection: 'stabile',
    blockState: 'attivo'
  };

  /* ===== Alert Center helpers ===== */
  function showAlertCenter({type='info', title='Reminder Protego', text='—', cta='Riduci ritmo'} = {}) {
    const box = document.getElementById('alert-center');
    const icon = document.getElementById('alert-icon');
    const t = document.getElementById('alert-title');
    const p = document.getElementById('alert-text');
    const ctaBtn = document.getElementById('alert-cta');

    if (!box || !icon || !t || !p || !ctaBtn) return;

    if (type === 'warning') {
      icon.style.backgroundColor = '#FFF4E5';
      icon.style.color = 'var(--alert-orange)';
      icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
    } else if (type === 'danger') {
      icon.style.backgroundColor = '#FEF2F2';
      icon.style.color = 'var(--danger-red)';
      icon.innerHTML = '<i class="fas fa-hand-paper"></i>';
    } else {
      icon.style.backgroundColor = 'rgba(166,230,213,0.35)';
      icon.style.color = 'var(--deep-emerald)';
      icon.innerHTML = '<i class="fas fa-shield-heart"></i>';
    }

    t.textContent = title;
    p.textContent = text;
    ctaBtn.textContent = cta;

    box.classList.remove('hidden');
  }

  function hideAlertCenter() {
    const box = document.getElementById('alert-center');
    if (box) box.classList.add('hidden');
  }

  /* ===== System status helpers ===== */
  function updateBlockStatus({ blocked=false, latency=32, connection='stabile' } = {}) {
    SYSTEM_STATUS.latencyMs = latency;
    SYSTEM_STATUS.connection = connection;
    SYSTEM_STATUS.blockState = blocked ? 'Blocco attivo' : 'Protezione OK';

    const blockStatus = document.getElementById('block-status');
    const latencyEl = document.getElementById('psd2-latency');
    const pill = document.getElementById('connection-pill');
    const label = document.getElementById('connection-label');

    if (blockStatus) blockStatus.textContent = SYSTEM_STATUS.blockState;
    if (latencyEl) latencyEl.innerHTML = `Sincronizzazione PSD2 ${connection} • Latenza <span class="font-semibold">${latency}ms</span>`;
    if (pill) {
      pill.style.borderColor = blocked ? 'rgba(214,64,69,0.3)' : 'rgba(29,122,111,0.35)';
      pill.style.backgroundColor = blocked ? '#FEF2F2' : 'rgba(166,230,213,0.25)';
    }
    if (label) label.textContent = `Connessione banca: ${connection}`;
  }

  /* ===== Nudge modal helpers ===== */
  function openNudge({title, text} = {}) {
    const now = Date.now();
    if (now - RG.lastNudgeAt < CONFIG.nudge.cooldownMs) return;
    RG.lastNudgeAt = now;

    const m = document.getElementById('nudge-modal');
    if (!m) return;

    const nt = document.getElementById('nudge-title');
    const nx = document.getElementById('nudge-text');
    if (title && nt) nt.textContent = title;
    if (text && nx) nx.textContent = text;

    m.classList.remove('hidden');
    m.classList.add('flex');

    addNotification({
      type: 'warning',
      title: 'Reminder Protego',
      message: 'Attività intensa rilevata: ti consigliamo una pausa breve.'
    });
  }

  function closeNudge(setSofter=false) {
@@ -995,50 +1429,53 @@
    m.classList.add('hidden');
    m.classList.remove('flex');
  }

  function evaluateResponsibleGaming(txCountLast7) {
    if (txCountLast7 >= CONFIG.nudge.txCountHard) {
      showAlertCenter({
        type: 'warning',
        title: 'Protego consiglia una pausa',
        text: 'Attività intensa rilevata. Una pausa breve ora aiuta a mantenere controllo e prevenire decisioni impulsive.',
        cta: 'Pausa 2 min'
      });

      openNudge({
        title: 'Pausa breve?',
        text: 'Hai avuto diverse transazioni ravvicinate. Anche 2 minuti possono interrompere l’automatismo e farti ripartire con lucidità.'
      });
    }
  }

  function generateTransactions() {
    const container = document.getElementById('transaction-list');
    let html = '';
    const today = new Date();

    const latency = Math.floor(Math.random() * 90) + 30; // 30-120ms
    const connection = latency > 110 ? 'instabile' : 'stabile';

    RG.monthSpendSim = 0;
    RG.blockedCount = 0;
    hideAlertCenter();

    const blockThreshold = CONFIG.responsibleGaming.monthlyLimit * CONFIG.responsibleGaming.blockMultiplier;

    for (let i = 0; i < 6; i++) {
      const site = bettingSites[Math.floor(Math.random() * bettingSites.length)];
      let rawAmount = Math.floor(Math.random() * 16) * 5 + 10; // 10..90 step 5
      const amount = rawAmount.toFixed(2);
      const invested = (rawAmount * currentSavingRate).toFixed(2);

      let date = new Date(today);
      date.setDate(today.getDate() - (i * 1.2));
      const dateStr = date.toLocaleDateString('it-IT', {weekday: 'short', day: 'numeric'});

      const projectedSpend = RG.monthSpendSim + rawAmount;

      let isBlocked = false;
      if (projectedSpend > blockThreshold) {
        isBlocked = true;
        RG.blockedCount += 1;

        if (RG.blockedCount === 1) {
          openBlock({
@@ -1076,50 +1513,51 @@
        <div class="card p-3 flex justify-between items-center ${isBlocked ? 'opacity-60' : ''}">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${site.class}">
              ${site.icon}
            </div>
            <div>
              <p class="font-bold text-sm" style="color: var(--navy-trust);">${site.name}</p>
              <p class="text-[10px] text-slate-500">${dateStr}${isBlocked ? ' • Bloccato' : ''}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="font-bold" style="color: ${isBlocked ? 'var(--danger-red)' : 'var(--navy-trust)'};">
              ${isBlocked ? 'Respinto' : '- € ' + amount}
            </p>
            <p class="text-[10px] text-slate-500">
              Protego: <span style="color: var(--deep-emerald);">+ € ${invested}</span>
            </p>
            <p class="text-[10px] font-semibold mt-0.5" style="color: ${isBlocked ? 'var(--danger-red)' : 'var(--deep-emerald)'};">
              ${isBlocked ? 'Limite superato' : '+ € ' + invested + ' salvati'}
            </p>
          </div>
        </div>
      `;
    }

    updateBlockStatus({ blocked: RG.blockedCount > 0, latency, connection });
    container.innerHTML = html;

    // Nudges after generation
    evaluateResponsibleGaming(6);

    // Near-limit reminder
    const nearLimit = RG.monthSpendSim > (blockThreshold * 0.85) && RG.blockedCount === 0;
    if (nearLimit) {
      showAlertCenter({
        type: 'warning',
        title: 'Quasi raggiunto il limite',
        text: 'Sei vicino alla tua soglia mensile. Vuoi attivare un limite più stretto per oggi?',
        cta: 'Attiva limite'
      });

      addNotification({
        type: 'warning',
        title: 'Quasi raggiunto il limite',
        message: 'Sei vicino alla tua soglia mensile. Protego consiglia una pausa o limiti più stretti.'
      });
    }
  }

  const years = ['2018', '2019', '2020', '2021', '2022', '2023', '2024'];

@@ -1166,90 +1604,309 @@
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    pendingSavingRate = currentSavingRate;
    highlightSelectedSavingOption(pendingSavingRate);
    updateSelectedRateLabel();
  }

  function closeSavingModal() {
    const modal = document.getElementById('saving-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function highlightSelectedSavingOption(rate) {
    document.querySelectorAll('.saving-option').forEach(btn => {
      const btnRate = parseFloat(btn.dataset.rate);
      btn.classList.remove('ring-2');
      btn.style.boxShadow = 'none';
      if (Math.abs(btnRate - rate) < 0.0001) {
        btn.classList.add('ring-2');
        btn.style.boxShadow = '0 0 0 2px rgba(29,122,111,0.4)';
      }
    });
  }

  function loadSavingRateFromStorage() {
    const saved = safeStorageGet(STORAGE_KEYS.savingRate);
    if (typeof saved === 'number' && !isNaN(saved)) {
      currentSavingRate = saved;
      pendingSavingRate = saved;
    }
    const percDisplay = Math.round(currentSavingRate * 100) + '%';
    setSavingLabel(percDisplay);
    highlightSelectedSavingOption(currentSavingRate);
    updateSelectedRateLabel();
  }

  function updateSelectedRateLabel() {
    const perc = Math.round(pendingSavingRate * 100);
    const label = document.getElementById('selected-rate-label');
    if (label) label.textContent = perc + '%';
  }

  function applySavingRate() {
    currentSavingRate = pendingSavingRate;
  function formatDuration(ms) {
    const sec = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    if (h > 0) return `${h}h ${m}m`;
    if (m > 0) return `${m}m ${s}s`;
    return `${s}s`;
  }

    const percDisplay = Math.round(currentSavingRate * 100) + '%';
  function setSavingLabel(percDisplay) {
    const savingRateLabel = document.getElementById('saving-rate-label');
    if (savingRateLabel) {
      savingRateLabel.innerHTML = 'Investimento autom.: <strong>' + percDisplay + '</strong> sui volumi';
      savingRateLabel.innerHTML = `Investimento autom.: <strong>${percDisplay}</strong> sui volumi <button onclick="openExplainability()" class="text-[10px] px-2 py-1 rounded-full border border-white/50 bg-white/70 text-slate-600 hover:text-slate-900" aria-label="Spiega come funziona">Come funziona</button>`;
    }
  }

  function persistSavingRate(rate) {
    safeStorageSet(STORAGE_KEYS.savingRate, rate);
  }

  function showCoolingBanner() {
    const banner = document.getElementById('cooling-banner');
    const countdown = document.getElementById('cooling-countdown');
    if (banner) banner.classList.remove('hidden');
    if (countdown && savingChange.demoDeadline) {
      countdown.textContent = formatDuration(savingChange.demoDeadline - new Date());
    }
  }

  function clearCoolingTimers() {
    if (savingChange.timer) clearTimeout(savingChange.timer);
    if (savingChange.countdown) clearInterval(savingChange.countdown);
    savingChange.timer = null;
    savingChange.countdown = null;
  }

  function persistCoolingState() {
    if (savingChange.pendingRate === null) {
      safeStorageRemove(STORAGE_KEYS.cooling);
      return;
    }
    safeStorageSet(STORAGE_KEYS.cooling, {
      pendingRate: savingChange.pendingRate,
      requestedAt: savingChange.requestedAt,
      deadline: savingChange.deadline,
      demoDeadline: savingChange.demoDeadline
    });
  }

  function loadCoolingState() {
    const saved = safeStorageGet(STORAGE_KEYS.cooling);
    if (!saved) return;
    const now = new Date();
    const demoDeadline = new Date(saved.demoDeadline);
    if (demoDeadline <= now) {
      safeStorageRemove(STORAGE_KEYS.cooling);
      return;
    }

    savingChange.pendingRate = saved.pendingRate;
    savingChange.requestedAt = saved.requestedAt ? new Date(saved.requestedAt) : now;
    savingChange.deadline = saved.deadline ? new Date(saved.deadline) : new Date(now.getTime() + CONFIG.coolingOffMs);
    savingChange.demoDeadline = demoDeadline;

    clearCoolingTimers();
    savingChange.timer = setTimeout(() => finalizeSavingRate(savingChange.pendingRate), savingChange.demoDeadline - now);
    startCoolingCountdown();
    showCoolingBanner();
  }

  function finalizeSavingRate(rate) {
    clearCoolingTimers();
    savingChange.pendingRate = null;
    savingChange.requestedAt = null;
    savingChange.deadline = null;
    savingChange.demoDeadline = null;
    persistCoolingState();

    currentSavingRate = rate;
    const percDisplay = Math.round(currentSavingRate * 100) + '%';
    setSavingLabel(percDisplay);
    const profileSaving = document.getElementById('profile-saving-rate');
    if (profileSaving) profileSaving.textContent = 'Attuale: ' + percDisplay;
    persistSavingRate(currentSavingRate);

    const banner = document.getElementById('cooling-banner');
    if (banner) banner.classList.add('hidden');

    updateDashboard(currentSavingRate);
    generateTransactions();

    addNotification({
      type: 'success',
      title: 'Cambio attivo',
      message: `La nuova percentuale ${percDisplay} è ora applicata dopo il periodo di cooling-off.`
    });

    maybePromptSaveProgress();
  }

  function startCoolingCountdown() {
    const countdown = document.getElementById('cooling-countdown');
    if (!countdown) return;
    savingChange.countdown = setInterval(() => {
      const remaining = savingChange.demoDeadline - new Date();
      countdown.textContent = formatDuration(remaining);
      if (remaining <= 0) clearCoolingTimers();
    }, 500);
  }

  function applySavingRate() {
    if (!CONSENT.monitoring) {
      showConsentBanner();
      addNotification({
        type: 'warning',
        title: 'Richiede consenso',
        message: 'Accetta il monitoraggio minimo GDPR per attivare modifiche di protezione.'
      });
      return;
    }

    savingChange.pendingRate = pendingSavingRate;
    savingChange.requestedAt = new Date();
    savingChange.deadline = new Date(Date.now() + CONFIG.coolingOffMs);
    savingChange.demoDeadline = new Date(Date.now() + CONFIG.coolingOffDemoMs);

    clearCoolingTimers();
    savingChange.timer = setTimeout(() => finalizeSavingRate(savingChange.pendingRate), CONFIG.coolingOffDemoMs);
    startCoolingCountdown();
    showCoolingBanner();
    closeSavingModal();
    persistCoolingState();
    maybePromptSaveProgress();

    addNotification({
      type: 'info',
      title: 'Percentuale aggiornata',
      message: `Nuovo rate: ${percDisplay}. Storico ricalcolato.`
      title: 'Cambio programmato',
      message: 'La modifica sarà attiva dopo la finestra di 48h (demo accelerata).'
    });
  }

  function cancelCoolingChange() {
    if (savingChange.pendingRate === null) return;
    clearCoolingTimers();
    savingChange.pendingRate = null;
    savingChange.requestedAt = null;
    savingChange.deadline = null;
    savingChange.demoDeadline = null;
    persistCoolingState();

    const banner = document.getElementById('cooling-banner');
    if (banner) banner.classList.add('hidden');

    addNotification({
      type: 'info',
      title: 'Cambio annullato',
      message: 'Hai annullato la modifica programmata. Le impostazioni restano invariate.'
    });
  }

  document.addEventListener('click', function (e) {
    if (e.target.classList && e.target.classList.contains('saving-option')) {
      const newRate = parseFloat(e.target.dataset.rate);
      if (!isNaN(newRate)) {
        pendingSavingRate = newRate;
        highlightSelectedSavingOption(pendingSavingRate);
        updateSelectedRateLabel();
      }
    }
  });

  /* ===== Alert center buttons ===== */
  document.addEventListener('click', function (e) {
    if (e.target && e.target.id === 'alert-dismiss') {
      hideAlertCenter();
    }
    if (e.target && e.target.id === 'alert-cta') {
      openNudge({
        title: 'Mini check-in',
        text: 'Vuoi fermarti un attimo e decidere consapevolmente? Impostare una pausa breve riduce il rischio di continuare “in automatico”.'
      });
    }
  });

  /* ===== Modals & helpers ===== */
  function openExplainability() {
    const modal = document.getElementById('explain-modal');
    if (modal) modal.classList.remove('hidden');
  }

  function closeExplainability() {
    const modal = document.getElementById('explain-modal');
    if (modal) modal.classList.add('hidden');
  }

  function openSupport() {
    const modal = document.getElementById('support-modal');
    if (modal) modal.classList.remove('hidden');
  }

  function closeSupport() {
    const modal = document.getElementById('support-modal');
    if (modal) modal.classList.add('hidden');
  }

  function openPartnerModal() {
    const modal = document.getElementById('partner-modal');
    if (modal) modal.classList.remove('hidden');
  }

  function closePartnerModal() {
    const modal = document.getElementById('partner-modal');
    if (modal) modal.classList.add('hidden');
  }

  function openSaveProgress() {
    const modal = document.getElementById('save-progress-modal');
    if (modal) modal.classList.remove('hidden');
  }

  function closeSaveProgress() {
    const modal = document.getElementById('save-progress-modal');
    if (modal) modal.classList.add('hidden');
  }

  function maybePromptSaveProgress() {
    if (PROGRESS_STATE.saved) return;
    const modal = document.getElementById('save-progress-modal');
    if (!modal) return;
    setTimeout(() => {
      if (!PROGRESS_STATE.saved) openSaveProgress();
    }, 600);
  }

  function triggerEmergencyBlock() {
    RG.blockedCount += 1;
    showAlertCenter({
      type: 'danger',
      title: 'Blocco emergenza attivato',
      text: 'Abbiamo sospeso tutte le transazioni e notificato il supporto. Puoi disattivare solo dopo 48h di raffreddamento.',
      cta: 'Capito'
    });
    openBlock({ attempt: 0, limit: CONFIG.responsibleGaming.monthlyLimit, projected: RG.monthSpendSim, siteName: 'Tutti i siti' });
    updateBlockStatus({ blocked: true, latency: SYSTEM_STATUS.latencyMs, connection: SYSTEM_STATUS.connection });
    addNotification({ type: 'danger', title: 'Blocco emergenza', message: 'Protezione totale attiva. Contatta il supporto per assistenza.' });
  }

  // Init
  loadConsentFromStorage();
  loadSavingRateFromStorage();
  loadCoolingState();
  updateDashboard(currentSavingRate);
  generateTransactions();
  updateBlockStatus({ blocked: false, latency: SYSTEM_STATUS.latencyMs, connection: SYSTEM_STATUS.connection });
  showConsentBanner();

  // Seed notifications
  addNotification({
    type: 'info',
    title: 'Protego attivo',
    message: 'Monitoraggio responsible gaming avviato. Ti avvisiamo in caso di rischi o superamento soglie.'
  });
</script>
</body>
</html>
