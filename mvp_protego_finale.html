<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Protego MVP - Fintech Ready</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0A1A2F">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --navy-trust: #0A1A2F;
      --deep-emerald: #1D7A6F;
      --sky-mint: #A6E6D5;
      --warm-gold: #C4A76F;
      --bg-main: #FFFFFF;
      --danger-red: #D64045;
      --alert-orange: #E8985E;
      --info-blue: #0F6CBD;
    }

    body {
      background-color: var(--bg-main);
      color: var(--navy-trust);
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
      transition: filter 0.3s ease; /* Transizione fluida per l'effetto offline */
    }

    /* Effetto visivo per la modalità offline */
    .grayscale-mode { filter: grayscale(100%); }

    .app-container {
      background-color: var(--bg-main);
      height: 100vh;
      width: 100%;
      max-width: 450px;
      margin: 0 auto;
      position: relative;
      display: flex;
      flex-direction: column;
      border-left: 1px solid rgba(10, 26, 47, 0.08);
      border-right: 1px solid rgba(10, 26, 47, 0.08);
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 140px; /* Spazio extra per il footer */
    }

    .card {
      background-color: #FFFFFF;
      border: 1px solid rgba(10, 26, 47, 0.08);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(10, 26, 47, 0.06);
    }

    .nav-item.active { color: var(--deep-emerald); }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 9999px;
      border: 1px solid rgba(10, 26, 47, 0.08);
      font-size: 11px;
      background-color: #F8FAFC;
    }

    /* Betting Logos simulation */
    .logo-sisal { background: #265C4B; color: white; }
    .logo-goldbet { background: #FFD700; color: black; }
    .logo-eurobet { background: #004588; color: white; }
    .logo-better { background: #F2F2F2; color: #D6001C; }
    .logo-snai { background: #E45F0F; color: white; }

    .bank-card {
      background: linear-gradient(135deg, var(--deep-emerald) 0%, var(--sky-mint) 100%);
      border: 1px solid rgba(10, 26, 47, 0.08);
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      color: #FFFFFF;
    }
    .bank-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -40%;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.25) 0%, rgba(0, 0, 0, 0) 70%);
    }

    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    /* Animation classes */
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .animate-slide-up { animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    
    /* Protego Logo Styles */
    .protego-logo { display: flex; align-items: center; gap: 12px; font-family: 'Nunito', sans-serif; cursor: default; }
    .logo-icon { position: relative; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; }
    .icon-shield { position: absolute; bottom: 0; width: 44px; height: 24px; border-bottom-left-radius: 50px; border-bottom-right-radius: 50px; background-color: var(--navy-trust); z-index: 1; }
    .icon-sphere { position: absolute; top: 8px; width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--sky-mint) 0%, var(--deep-emerald) 100%); z-index: 2; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
    .icon-sphere::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent 60%); }
    .icon-star { position: absolute; top: 0; left: 12px; width: 14px; height: 14px; background-color: var(--warm-gold); clip-path: polygon(50% 0%, 65% 35%, 100% 50%, 65% 65%, 50% 100%, 35% 65%, 0% 50%, 35% 35%); z-index: 3; }
    .logo-text { font-size: 2rem; font-weight: 800; color: var(--navy-trust); letter-spacing: -0.02em; line-height: 1; }
    @media (max-width: 600px) { .logo-icon { transform: scale(0.8); } .logo-text { font-size: 1.6rem; } }
  </style>
</head>

<body>
<div class="app-container">

  <header class="p-5 flex flex-col gap-2 bg-white/95 backdrop-blur sticky top-0 z-20 border-b border-[rgba(10,26,47,0.06)]">
    <div class="flex justify-between items-center">
      <div class="protego-logo">
        <div class="logo-icon">
          <div class="icon-star"></div>
          <div class="icon-shield"></div>
          <div class="icon-sphere"></div>
        </div>
        <div class="logo-text">Protego</div>
      </div>

      <div class="flex items-center gap-3">
        <div id="online-badge" class="px-2 py-1 rounded text-xs border flex items-center gap-1 transition-colors duration-300"
             style="background-color: rgba(166,230,213,0.25); border-color: rgba(29,122,111,0.35); color: var(--deep-emerald);">
          <i class="fas fa-signal text-[10px]"></i>
          <span id="connection-text">Online</span>
        </div>

        <button class="relative" onclick="openNotifications()" aria-label="Notifiche">
          <i class="fas fa-bell text-slate-400"></i>
          <span id="notif-dot" class="absolute -top-1 -right-1 w-2 h-2 rounded-full border border-white" style="background-color: var(--warm-gold); display:none;"></span>
        </button>
      </div>
    </div>
  </header>

  <main id="main-content" class="content-area scrollbar-hide">

    <section id="view-home" class="px-5 py-4 space-y-6">
      <div class="text-center py-4">
        <p class="text-slate-500 text-sm uppercase tracking-widest mb-1">Salvato finora</p>
        <h1 class="text-5xl font-bold mb-2" style="color: var(--navy-trust);">
          <span id="home-total-display">€ 14.500</span><span class="text-slate-400 text-3xl">,00</span>
        </h1>

        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border mb-2"
             style="background: linear-gradient(90deg, rgba(166,230,213,0.35) 0%, rgba(29,122,111,0.20) 100%); border-color: rgba(29,122,111,0.45);">
          <i class="fas fa-magic text-xs" style="color: var(--warm-gold);"></i>
          <span id="saving-rate-label" class="text-xs flex items-center gap-2" style="color: var(--navy-trust);">
            Investimento autom.: <strong>12%</strong> sui volumi
             <button onclick="openExplainability()" class="ml-1 w-4 h-4 rounded-full border border-slate-300 flex items-center justify-center text-[9px] text-slate-500 hover:bg-slate-100">?</button>
          </span>
        </div>

        <div id="rg-cooling-banner" class="hidden mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg flex flex-wrap items-center gap-2 animate-pulse shadow-sm">
          <i class="fas fa-hourglass-half text-amber-600"></i>
          <span class="text-xs text-amber-800 flex-1 leading-tight">
            Modifica limiti in attesa di sicurezza. Attivazione tra <strong id="rg-cooling-countdown">48:00:00</strong>.
          </span>
          <button onclick="cancelRGChange()" class="text-[10px] px-3 py-1.5 rounded border border-amber-300 bg-white text-amber-700 font-bold hover:bg-amber-50">
            Annulla
          </button>
        </div>

        <div class="mt-2 inline-flex items-center gap-2 px-3 py-2 rounded-full border"
             style="background-color: #FFF9ED; border-color: rgba(196,167,111,0.55);">
          <i class="fas fa-heartbeat text-xs" style="color: var(--warm-gold);"></i>
          <span class="text-[11px]" style="color: var(--navy-trust);">
            Modalità <strong>Protezione</strong> attiva • Limite mensile: <strong id="home-monthly-limit">€ 1.200</strong>
          </span>
        </div>

        <div class="mt-5 w-full max-w-xs mx-auto text-left">
          <div class="flex justify-between text-[10px] text-slate-500 mb-1">
            <span>Obiettivo: Fondo Sicurezza € 20.000</span>
            <span id="goal-percentage">73%</span>
          </div>
          <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
            <div id="goal-bar" class="h-full" style="background: linear-gradient(90deg, var(--deep-emerald), var(--sky-mint)); width:73%"></div>
          </div>
        </div>
      </div>

      <section aria-label="Reminder Protego" class="space-y-2">
        <div id="alert-center" class="card p-3 hidden">
          <div class="flex items-start gap-3">
            <div id="alert-icon" class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: rgba(166,230,213,0.35); color: var(--deep-emerald);">
              <i class="fas fa-shield-heart"></i>
            </div>
            <div class="flex-1">
              <p id="alert-title" class="font-bold text-sm" style="color: var(--navy-trust);">Reminder Protego</p>
              <p id="alert-text" class="text-xs text-slate-500 mt-0.5 leading-relaxed">—</p>
              <div class="flex gap-2 mt-3">
                <button id="alert-dismiss" class="px-3 py-2 rounded-lg text-xs font-semibold border border-slate-200 text-slate-500">Ok</button>
                <button id="alert-cta" class="px-3 py-2 rounded-lg text-xs font-semibold" style="background: rgba(166,230,213,0.55); color: var(--navy-trust);">Riduci ritmo</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section aria-label="Transazioni recenti">
        <div class="flex justify-between items-end mb-3">
          <h3 class="font-bold text-lg" style="color: var(--navy-trust);">Transazioni Recenti</h3>
          <span class="text-xs text-slate-500">Ultimi 7 giorni (PSD2 Live)</span>
        </div>
        <div class="space-y-3" id="transaction-list"></div>
      </section>
    </section>

    <section id="view-stats" class="px-5 py-4 space-y-6 hidden">
      <h2 class="text-2xl font-bold" style="color: var(--navy-trust);">Patrimonio Proiettato</h2>
      <div class="grid grid-cols-2 gap-3">
        <div class="card p-4">
          <p class="text-xs text-slate-500">Totale Versato</p>
          <p class="text-xl font-bold" id="stats-total-display" style="color: var(--navy-trust);">€ 14.500</p>
          <p class="text-[10px] text-slate-500 mt-1">Capitale puro accumulato.</p>
        </div>
        <div class="card p-4" style="border-color: rgba(29,122,111,0.5); background: linear-gradient(135deg, rgba(166,230,213,0.35), rgba(29,122,111,0.12));">
          <p class="text-xs" style="color: var(--deep-emerald);">Scenario Medio (+8%)</p>
          <p class="text-xl font-bold" id="val-medio" style="color: var(--deep-emerald);">€ 19.800</p>
          <p class="text-[10px] mt-1" id="val-medio-breakdown" style="color: var(--navy-trust); opacity:0.75;">Stima indicativa.</p>
        </div>
      </div>
      <div class="card p-4">
        <div class="flex justify-between mb-4 items-center">
          <h3 class="font-bold text-sm" style="color: var(--navy-trust);">Scenari di Crescita</h3>
          <span class="text-[10px] text-slate-500">*Fee 2% incluse</span>
        </div>
        <div class="relative h-64 w-full">
          <canvas id="growthChart"></canvas>
        </div>
      </div>
    </section>

    <section id="view-cards" class="px-5 py-4 space-y-6 hidden">
      <h2 class="text-2xl font-bold" style="color: var(--navy-trust);">Wallet & Conti</h2>
      <p class="text-slate-500 text-sm">Metodi collegati per il prelievo automatico dal gioco.</p>
      <div class="space-y-4 mt-2">
        <div class="bank-card p-5 shadow-xl">
          <div class="flex justify-between items-start mb-8 relative z-10">
            <i class="fas fa-wifi text-white/70 rotate-90"></i>
            <span class="font-bold italic text-white/80">VISA</span>
          </div>
          <div class="text-lg font-mono tracking-widest text-white relative z-10 mb-2">**** **** **** 4589</div>
          <div class="flex justify-between text-xs text-white/80 relative z-10">
            <span>Mario Rossi</span><span>Exp 09/28</span>
          </div>
        </div>
      </div>
    </section>

    <section id="view-profile" class="px-5 py-4 space-y-6 hidden">
      <div class="flex items-center gap-4 mb-6">
        <div class="w-16 h-16 rounded-full border-2 overflow-hidden flex items-center justify-center" style="border-color: var(--deep-emerald); background-color:#E5EEF3;">
          <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Mario" alt="Avatar" class="w-full h-full">
        </div>
        <div>
          <h2 class="text-xl font-bold" style="color: var(--navy-trust);">Mario Rossi</h2>
          <p class="text-sm text-slate-500">ID: #88291 • Premium</p>
        </div>
      </div>

      <div class="card p-4 space-y-4 border-l-4" style="border-left-color: var(--deep-emerald);">
        <div class="flex justify-between items-center">
             <h3 class="font-bold text-sm" style="color: var(--navy-trust);">Protezione Gioco (Cooling-off attivo)</h3>
             <i class="fas fa-shield-alt text-emerald-600"></i>
        </div>

        <div>
          <label class="text-xs text-slate-500">Limite mensile di gioco (€)</label>
          <input id="monthly-limit-input" type="number" value="1200" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
        </div>

        <div>
          <label class="text-xs text-slate-500">Soglia Autoblocco (su limite)</label>
          <select id="block-threshold-select" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
            <option value="1.0">Rigida – 100% del limite</option>
            <option value="1.1" selected>Standard – 110%</option>
            <option value="1.2">Flessibile – 120%</option>
          </select>
        </div>

        <button onclick="applyRGSettings()" class="w-full py-3 rounded-lg text-sm font-bold text-white shadow-md transform active:scale-95 transition" style="background: linear-gradient(90deg, var(--deep-emerald), var(--sky-mint));">
          Salva con sicurezza (48h)
        </button>
      </div>

      <div class="card p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded flex items-center justify-center" style="background-color:#E5EEF3; color: var(--deep-emerald);">
              <i class="fas fa-file-contract"></i>
            </div>
            <span style="color: var(--navy-trust);">Consensi GDPR & Privacy</span>
          </div>
          <button onclick="showConsentBanner()" class="text-xs text-blue-600 font-semibold">Gestisci</button>
      </div>
    </section>
  </main>

  <footer class="px-5 pt-4 pb-10 bg-white border-t border-[rgba(10,26,47,0.08)] text-[10px] text-slate-400 leading-relaxed text-center">
    <p>Protego S.r.l. • P.IVA 12345678901 • RUI E000999999</p>
    <p class="mt-1">Design etico e conforme PSD2. I dati vengono trattati nel rispetto del GDPR.</p>
    <div class="h-12"></div>
  </footer>

  <nav class="h-[80px] bg-white border-t border-[rgba(10,26,47,0.06)] flex justify-around items-center px-2 fixed bottom-0 w-full max-w-[450px] z-30">
    <button onclick="switchTab('home')" id="nav-home" class="nav-item active flex flex-col items-center gap-1 p-2 w-16 transition" style="color: var(--navy-trust);">
      <i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-semibold">Home</span>
    </button>
    <button onclick="switchTab('stats')" id="nav-stats" class="nav-item text-slate-400 flex flex-col items-center gap-1 p-2 w-16 transition">
      <i class="fas fa-chart-line text-xl mb-1"></i><span class="text-[10px] font-semibold">Stats</span>
    </button>
    <button type="button" onclick="openSavingModal()" class="relative -top-6 focus:outline-none">
      <div class="w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-4" style="background: radial-gradient(circle at 30% 30%, var(--sky-mint), var(--deep-emerald)); border-color:#FFFFFF;">
        <i class="fas fa-shield-alt text-xl" style="color: var(--navy-trust);"></i>
      </div>
    </button>
    <button onclick="switchTab('cards')" id="nav-cards" class="nav-item text-slate-400 flex flex-col items-center gap-1 p-2 w-16 transition">
      <i class="fas fa-credit-card text-xl mb-1"></i><span class="text-[10px] font-semibold">Cards</span>
    </button>
    <button onclick="switchTab('profile')" id="nav-profile" class="nav-item text-slate-400 flex flex-col items-center gap-1 p-2 w-16 transition">
      <i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-semibold">Profile</span>
    </button>
  </nav>

  <div id="consent-banner" class="fixed left-0 right-0 mx-auto max-w-[450px] bottom-24 z-[80] hidden animate-slide-up">
    <div class="m-3 p-4 rounded-2xl shadow-2xl border border-[rgba(10,26,47,0.08)] bg-white/95 backdrop-blur">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color: rgba(15,108,189,0.1); color: var(--info-blue);">
          <i class="fas fa-user-shield"></i>
        </div>
        <div class="flex-1 space-y-2">
          <h3 class="font-bold text-sm" style="color: var(--navy-trust);">Consenso esplicito GDPR</h3>
          <p class="text-xs text-slate-600 leading-relaxed">Per attivare i blocchi e proteggerti, Protego deve trattare dati particolari (categorie speciali ex Art. 9 GDPR). Il consenso è libero e revocabile.</p>
          
          <div class="flex gap-2 mt-2">
            <button onclick="acceptConsents()" class="flex-1 py-2 rounded-lg text-xs font-bold text-white shadow-md" style="background: linear-gradient(90deg, var(--deep-emerald), var(--sky-mint));">Accetto e Proteggimi</button>
            <button onclick="closeConsentBanner()" class="px-3 py-2 rounded-lg text-xs font-semibold border border-slate-200 hover:bg-slate-50">Solo essenziali</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="explain-modal" class="fixed inset-0 bg-black/40 hidden z-[70] flex items-end justify-center">
    <div class="absolute inset-0" onclick="closeExplainability()"></div>
    <div class="w-full max-w-[450px] bg-white rounded-t-2xl p-5 space-y-3 animate-slide-up shadow-2xl">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold" style="color: var(--navy-trust);">Come decide Protego</h3>
        <button onclick="closeExplainability()" class="text-sm text-slate-400">Chiudi</button>
      </div>
      <ul class="list-disc pl-4 text-sm text-slate-600 space-y-2">
        <li>Il rate automatico (12%) è calcolato sul volume netto dei depositi monitorati via PSD2.</li>
        <li><strong>Frizione Positiva:</strong> Ogni modifica ai limiti entra in vigore dopo un periodo di "cooling-off" (48h) per evitare decisioni impulsive.</li>
        <li>Se superi il limite mensile, scatta l'autoblocco immediato tramite rifiuto transazione.</li>
      </ul>
      <p class="text-[10px] text-slate-400 mt-2 bg-slate-50 p-2 rounded">Conforme AI Act: logica trasparente e non discriminatoria.</p>
    </div>
  </div>

  <div id="saving-modal" class="fixed inset-0 bg-black/40 flex items-end justify-center z-40 hidden">
    <div class="w-full max-w-[450px] bg-white rounded-t-2xl border-t border-[rgba(10,26,47,0.08)] p-5 space-y-4 animate-slide-up">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold" style="color: var(--navy-trust);">Imposta la protezione</h3>
        <button onclick="closeSavingModal()" class="text-slate-400 text-sm">Chiudi</button>
      </div>
      <p class="text-xs text-slate-500">Scegli la percentuale di ogni deposito che Protego sposta automaticamente.</p>
      <div class="flex gap-2">
        <button class="saving-option flex-1 py-3 rounded-xl border text-sm" data-rate="0.05" style="border-color: rgba(10,26,47,0.15); background-color:#F9FAFB;">5% • Light</button>
        <button class="saving-option flex-1 py-3 rounded-xl border text-sm" data-rate="0.12" style="border-color: rgba(29,122,111,0.5); background: linear-gradient(135deg, rgba(166,230,213,0.5), rgba(29,122,111,0.15));">12% • Standard</button>
        <button class="saving-option flex-1 py-3 rounded-xl border text-sm" data-rate="0.20" style="border-color: rgba(196,167,111,0.7); background-color:#FFF9ED;">20% • Forte</button>
      </div>
      <button type="button" onclick="applySavingRate()" class="w-full mt-2 py-3 rounded-xl text-sm font-semibold text-white shadow" style="background: linear-gradient(90deg, var(--deep-emerald), var(--sky-mint));">Applica e ricalcola storico</button>
    </div>
  </div>

  <div id="notifications-modal" class="fixed inset-0 bg-black/30 hidden z-[70] flex items-end justify-center">
      <div class="absolute inset-0" onclick="closeNotifications()"></div>
      <div class="w-full max-w-[450px] bg-white rounded-t-2xl p-5 animate-slide-up h-[60vh] flex flex-col">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-bold" style="color: var(--navy-trust);">Notifiche</h3>
          <button onclick="closeNotifications()" class="text-sm text-slate-400">Chiudi</button>
        </div>
        <div id="notifications-list" class="space-y-2 overflow-y-auto scrollbar-hide flex-1"></div>
      </div>
  </div>

</div>

<script>
  /* ===== CONFIGURAZIONE & STATO ===== */
  const CONFIG = {
    goalValue: 20000,
    fee: 0.02,
    defaultSavingRate: 0.12,
    responsibleGaming: { monthlyLimit: 1200, blockMultiplier: 1.10 }
  };

  const RG_CHANGE = {
    pendingLimit: null,
    pendingMult: null,
    timer: null,
    secondsLeft: 0
  };

  const NOTIFS = { items: [], unread: 0 };
  let currentSavingRate = 0.12;
  let pendingSavingRate = 0.12;

  // Dati storici simulati
  const rawHistory = [2000, 4100, 6200, 8300, 10400, 12500, 14500];
  const baseVolumeHistory = rawHistory.map(val => val / CONFIG.defaultSavingRate);

  /* ===== UTILS ===== */
  const fmtEur = (val) => '€ ' + Math.floor(val).toLocaleString('it-IT');
  const fmtDate = (d) => d.toLocaleString('it-IT', { hour: '2-digit', minute:'2-digit' });

  /* ===== CORE LOGIC: COOLING OFF ===== */
  function applyRGSettings() {
    const newLimit = parseFloat(document.getElementById('monthly-limit-input').value);
    const newMult = parseFloat(document.getElementById('block-threshold-select').value);

    // Simuliamo la frizione positiva (Design Etico)
    RG_CHANGE.pendingLimit = newLimit;
    RG_CHANGE.pendingMult = newMult;
    RG_CHANGE.secondsLeft = 10; // Demo: 10 secondi invece di 48h

    const banner = document.getElementById('rg-cooling-banner');
    const countdown = document.getElementById('rg-cooling-countdown');
    banner.classList.remove('hidden');
    
    // Scroll to top to see banner
    document.querySelector('.content-area').scrollTo({ top: 0, behavior: 'smooth' });

    addNotification({
      type: 'warning', 
      title: 'Modifica in attesa (Cooling-off)', 
      message: 'Per la tua sicurezza, le modifiche ai limiti saranno attive tra 48 ore (demo: 10s).'
    });

    if (RG_CHANGE.timer) clearInterval(RG_CHANGE.timer);
    
    RG_CHANGE.timer = setInterval(() => {
      RG_CHANGE.secondsLeft--;
      countdown.textContent = `00:00:${RG_CHANGE.secondsLeft < 10 ? '0' : ''}${RG_CHANGE.secondsLeft}`;
      
      if (RG_CHANGE.secondsLeft <= 0) {
        finalizeRGSettings();
      }
    }, 1000);
  }

  function finalizeRGSettings() {
    clearInterval(RG_CHANGE.timer);
    const banner = document.getElementById('rg-cooling-banner');
    banner.classList.add('hidden');

    CONFIG.responsibleGaming.monthlyLimit = RG_CHANGE.pendingLimit;
    CONFIG.responsibleGaming.blockMultiplier = RG_CHANGE.pendingMult;

    document.getElementById('home-monthly-limit').textContent = fmtEur(CONFIG.responsibleGaming.monthlyLimit);
    
    addNotification({
      type: 'success',
      title: 'Limiti Aggiornati',
      message: `Il periodo di raffreddamento è terminato. Nuovi limiti attivi.`
    });
    
    // Rigenera transazioni per riflettere i nuovi limiti
    generateTransactions();
  }

  function cancelRGChange() {
    clearInterval(RG_CHANGE.timer);
    document.getElementById('rg-cooling-banner').classList.add('hidden');
    addNotification({ type:'info', title:'Modifica annullata', message:'I limiti sono rimasti invariati.' });
  }

  /* ===== CORE LOGIC: TRANSAZIONI REALISTICHE (PSD2) ===== */
  const bettingSites = [
    {name: "Sisal Matchpoint", class: "logo-sisal", icon: "S"},
    {name: "GoldBet", class: "logo-goldbet", icon: "G"},
    {name: "Eurobet", class: "logo-eurobet", icon: "E"},
    {name: "Lottomatica", class: "logo-better", icon: "L"},
    {name: "SNAI", class: "logo-snai", icon: "S"}
  ];

  function generateTransactions() {
    const list = document.getElementById('transaction-list');
    let html = '';
    const today = new Date();
    let monthSpend = 0;
    const threshold = CONFIG.responsibleGaming.monthlyLimit * CONFIG.responsibleGaming.blockMultiplier;

    for (let i = 0; i < 6; i++) {
      const site = bettingSites[Math.floor(Math.random() * bettingSites.length)];
      const amount = Math.floor(Math.random() * 16) * 5 + 10; 
      const invested = (amount * currentSavingRate).toFixed(2);
      
      let date = new Date(today);
      date.setDate(today.getDate() - (i * 1));
      const dateStr = date.toLocaleDateString('it-IT', {weekday:'short', day:'numeric'});

      // Logica realistica PSD2: Status e Arricchimento
      const isPending = i === 0 && Math.random() > 0.5; // La più recente può essere pending
      const statusBadge = isPending 
        ? `<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-slate-100 text-slate-500 border border-slate-200 uppercase tracking-wide">Pending</span>`
        : `<i class="fas fa-check-circle text-teal-500 text-[10px]" title="Contabilizzata"></i>`;
      
      const enrichmentInfo = `<span class="text-[9px] text-slate-400 ml-1 border px-1 rounded">MCC 7995</span>`;

      // Logica Blocco
      monthSpend += amount;
      const isBlocked = monthSpend > threshold;
      
      html += `
        <div class="card p-3 flex justify-between items-center ${isBlocked ? 'opacity-70 bg-red-50/30' : ''}">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${site.class} text-white shadow-sm">
              ${site.icon}
            </div>
            <div>
              <p class="font-bold text-sm" style="color: var(--navy-trust);">${site.name}</p>
              <div class="flex items-center gap-1.5 mt-0.5">
                <span class="text-[10px] text-slate-500">${dateStr}</span>
                ${statusBadge}
                ${isBlocked ? enrichmentInfo : ''}
              </div>
            </div>
          </div>
          <div class="text-right">
            <p class="font-bold ${isBlocked ? 'text-[var(--danger-red)]' : 'text-[var(--navy-trust)]'}">
              ${isBlocked ? 'Respinto' : '- € ' + amount.toFixed(2)}
            </p>
            <p class="text-[10px] font-semibold ${isBlocked ? 'text-red-400' : 'text-[var(--deep-emerald)]'}">
              ${isBlocked ? 'Limite superato' : '+ € ' + invested + ' salvati'}
            </p>
          </div>
        </div>
      `;
    }
    list.innerHTML = html;
  }

  /* ===== PWA & OFFLINE LOGIC ===== */
  window.addEventListener('offline', () => {
    document.body.classList.add('grayscale-mode');
    document.getElementById('connection-text').textContent = 'Offline';
    document.getElementById('online-badge').style.borderColor = '#94a3b8';
    document.getElementById('online-badge').style.color = '#64748b';
    document.getElementById('online-badge').style.backgroundColor = '#f1f5f9';
    addNotification({type: 'danger', title: 'Connessione persa', message: 'Modalità offline attiva. Dati in sola lettura.'});
  });

  window.addEventListener('online', () => {
    document.body.classList.remove('grayscale-mode');
    document.getElementById('connection-text').textContent = 'Online';
    // reset colors
    document.getElementById('online-badge').style = "background-color: rgba(166,230,213,0.25); border-color: rgba(29,122,111,0.35); color: var(--deep-emerald);";
    addNotification({type: 'success', title: 'Tornati online', message: 'Sincronizzazione PSD2 completata.'});
  });

  /* ===== NOTIFICATIONS ===== */
  function addNotification({ type='info', title, message }) {
    const colors = {
      info: 'bg-blue-50 text-blue-600',
      success: 'bg-emerald-50 text-emerald-600',
      warning: 'bg-amber-50 text-amber-600',
      danger: 'bg-red-50 text-red-600'
    };
    const icons = {
      info: 'fa-info-circle',
      success: 'fa-check-circle',
      warning: 'fa-exclamation-triangle',
      danger: 'fa-ban'
    };

    const item = `
      <div class="p-3 rounded-lg border border-slate-100 flex gap-3 animate-slide-up bg-white shadow-sm mb-2">
        <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${colors[type]}">
          <i class="fas ${icons[type]} text-xs"></i>
        </div>
        <div>
          <p class="text-xs font-bold text-slate-700">${title}</p>
          <p class="text-[11px] text-slate-500 leading-tight mt-0.5">${message}</p>
          <p class="text-[9px] text-slate-400 mt-1">${fmtDate(new Date())}</p>
        </div>
      </div>
    `;
    
    NOTIFS.items.unshift(item);
    NOTIFS.unread++;
    document.getElementById('notif-dot').style.display = 'block';
    
    // Render immediately if modal is open
    const list = document.getElementById('notifications-list');
    if(!document.getElementById('notifications-modal').classList.contains('hidden')) {
      list.innerHTML = NOTIFS.items.join('');
    }
  }

  function openNotifications() {
    document.getElementById('notifications-modal').classList.remove('hidden');
    document.getElementById('notifications-list').innerHTML = NOTIFS.items.length ? NOTIFS.items.join('') : '<p class="text-center text-xs text-slate-400 mt-10">Nessuna notifica</p>';
    NOTIFS.unread = 0;
    document.getElementById('notif-dot').style.display = 'none';
  }

  /* ===== GDPR & MODALS ===== */
  function showConsentBanner() { document.getElementById('consent-banner').classList.remove('hidden'); }
  function closeConsentBanner() { document.getElementById('consent-banner').classList.add('hidden'); }
  function acceptConsents() {
    closeConsentBanner();
    addNotification({type:'success', title:'Consenso GDPR', message:'Hai abilitato la protezione avanzata basata sui dati di gioco.'});
  }

  function openExplainability() { document.getElementById('explain-modal').classList.remove('hidden'); }
  function closeExplainability() { document.getElementById('explain-modal').classList.add('hidden'); }

  function openSavingModal() { document.getElementById('saving-modal').classList.remove('hidden'); document.getElementById('saving-modal').classList.add('flex'); }
  function closeSavingModal() { document.getElementById('saving-modal').classList.add('hidden'); document.getElementById('saving-modal').classList.remove('flex'); }
  function closeNotifications() { document.getElementById('notifications-modal').classList.add('hidden'); }

  function switchTab(tabId) {
    document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById('view-' + tabId).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active'); el.classList.add('text-slate-400'); });
    document.getElementById('nav-' + tabId).classList.add('active');
    document.getElementById('nav-' + tabId).classList.remove('text-slate-400');
    if(tabId === 'stats') renderChart();
  }

  function applySavingRate() {
    // Demo logic for saving rate change
    closeSavingModal();
    addNotification({type:'info', title:'Rate Aggiornato', message:'Nuovo tasso di risparmio applicato.'});
    generateTransactions();
  }

  /* ===== CHART ===== */
  function renderChart() {
    const ctx = document.getElementById('growthChart').getContext('2d');
    if(window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['2023', '2024', '2025', '2026', '2027', '2028', '2029'],
        datasets: [
          { label: 'Medio', data: [14500, 16000, 18500, 21000, 24500, 28000, 32000], borderColor: '#1D7A6F', backgroundColor: 'rgba(166,230,213,0.3)', fill: true, tension:0.4 }
        ]
      },
      options: { plugins: {legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{display:false}} }
    });
  }

  // INIT
  generateTransactions();
  setTimeout(showConsentBanner, 1500); // Mostra GDPR dopo 1.5s
</script>
</body>
</html>
